{% extends 'base.html' %}

{% block content %}
<div class="max-w-6xl mx-auto h-[80vh] flex shadow-2xl rounded-[2rem] overflow-hidden border border-gray-100 bg-white my-4">
    <div class="hidden md:flex w-1/3 border-r border-gray-100 flex-col bg-gray-50/50">
        <div class="p-6 bg-white border-b border-gray-100"><h2 class="text-xl font-black text-gray-800 italic">Chat History</h2></div>
        <div class="flex-1 overflow-y-auto p-4" id="history-list">
            {% for msg in history %}
            <div class="p-3 bg-white rounded-xl mb-2 shadow-sm text-xs truncate">ğŸ  {{ msg.message }}</div>
            {% endfor %}
        </div>
    </div>

    <div class="flex-1 flex flex-col bg-[#F0F7FF]"> 
        <div class="p-4 bg-white border-b border-blue-100 flex items-center justify-between shadow-sm">
            <span class="font-black text-blue-600 flex items-center gap-2">ì–´í•­ ë„ìš°ë¯¸ AI</span>
        </div>

        <div id="chat-window" class="flex-1 overflow-y-auto p-6 space-y-6">
            <div class="flex items-start gap-3">
                <div class="w-10 h-10 rounded-2xl bg-blue-600 flex items-center justify-center text-white text-xs font-black shadow-lg">AI</div>
                <div class="bg-white p-4 rounded-2xl rounded-tl-none shadow-sm border border-blue-50 text-sm font-medium max-w-[75%] text-gray-800">
                    ì•ˆë…•í•˜ì„¸ìš”! <strong>{{ user.username }}</strong>ë‹˜ ğŸ <br>
                    ë¬¼ê³ ê¸° ìƒíƒœê°€ ì´ìƒí•˜ë©´ <strong>ì‚¬ì§„(ğŸ“·)</strong>ì„ ì°ì–´ ì˜¬ë ¤ì£¼ì„¸ìš”!
                </div>
            </div>
        </div>

        <div class="p-5 bg-white border-t border-blue-50">
            <form id="chat-form" enctype="multipart/form-data">
                {% csrf_token %}
                <div id="image-preview" class="hidden mb-3 p-3 bg-blue-50 rounded-2xl border-2 border-dashed border-blue-200 flex items-center justify-between">
                    <span id="file-name" class="text-xs font-bold text-blue-700"></span>
                    <button type="button" onclick="resetImage()" class="text-red-500 font-black">Ã—</button>
                </div>

                <div class="flex items-center gap-3">
                    <label class="flex-shrink-0 w-12 h-12 bg-blue-50 rounded-2xl flex items-center justify-center cursor-pointer hover:bg-blue-100 transition-all border-2 border-blue-100 shadow-sm">
                        <input type="file" id="image-input" name="image" accept="image/*" class="hidden">
                        <span class="text-2xl">ğŸ“·</span>
                    </label>

                    <div class="flex-1">
                        <input type="text" id="user-input" name="message" placeholder="ë¬¼ë¬¼ë°•ì‚¬ì—ê²Œ ì§ˆë¬¸í•˜ê¸°..." 
                            class="w-full bg-gray-50 border-2 border-transparent focus:border-blue-300 focus:bg-white rounded-2xl px-5 py-3.5 outline-none text-sm font-medium transition-all shadow-inner">
                    </div>

                    <button type="submit" class="flex-shrink-0 w-14 h-14 bg-blue-600 text-white rounded-2xl shadow-lg flex items-center justify-center hover:scale-105 transition-all">
                        <span class="text-3xl">ğŸ </span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    const chatForm = document.getElementById('chat-form');
    const chatWindow = document.getElementById('chat-window');
    const userInput = document.getElementById('user-input');
    const imageInput = document.getElementById('image-input');
    const imagePreview = document.getElementById('image-preview');
    const fileNameDisp = document.getElementById('file-name');

    imageInput.addEventListener('change', function() {
        if (this.files && this.files[0]) {
            fileNameDisp.innerText = this.files[0].name;
            imagePreview.classList.remove('hidden');
        }
    });

    function resetImage() { imageInput.value = ""; imagePreview.classList.add('hidden'); }

    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const message = userInput.value.trim();
        if (!message && !imageInput.files[0]) return;

        appendMessage('user', message || "ì‚¬ì§„ ë¶„ì„ì„ ìš”ì²­í•©ë‹ˆë‹¤.");
        userInput.value = '';
        resetImage();

        const loadingId = 'loading-' + Date.now();
        appendMessage('ai', 'ë¬¼ê³ ê¸°ë¥¼ ì§„ì°°í•˜ê³  ìˆìŠµë‹ˆë‹¤...ğŸ«§', loadingId);

        fetch("{% url 'chatbot:ask' %}", {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            const loadingBubble = document.getElementById(loadingId);
            if (loadingBubble) loadingBubble.closest('.flex').remove();
            if (data.status === 'success') { appendMessage('ai', data.message); }
            else { appendMessage('ai', "ì—ëŸ¬: " + data.message); }
        });
    });

    function appendMessage(sender, text, id = null) {
        const div = document.createElement('div');
        div.className = sender === 'user' ? 'flex justify-end' : 'flex items-start gap-3';
        const bubbleClass = sender === 'user' ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-white text-gray-800 border-blue-50 rounded-tl-none';
        
        div.innerHTML = `
            ${sender === 'ai' ? '<div class="w-10 h-10 rounded-2xl bg-blue-600 flex items-center justify-center text-white text-xs font-black">AI</div>' : ''}
            <div id="${id || ''}" class="p-4 rounded-2xl text-sm font-medium max-w-[75%] shadow-md ${bubbleClass}">
                ${text.replace(/\n/g, '<br>')}
            </div>`;
        chatWindow.appendChild(div);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }
</script>
{% endblock %}