{% extends 'base.html' %}

{% block content %}
<div class="max-w-[450px] mx-auto h-[82vh] flex flex-col shadow-2xl rounded-[2.5rem] overflow-hidden border border-white/50 bg-white/80 backdrop-blur-xl my-4 relative animate-fade-in">
    
    <div class="p-5 bg-gradient-to-r from-blue-600 to-cyan-500 text-white flex items-center justify-between shadow-md">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-white/20 backdrop-blur-md rounded-2xl flex items-center justify-center border border-white/30 shadow-inner text-xl">ğŸ </div>
            <div>
                <h2 class="font-black text-sm leading-tight text-white">ì–´í•­ ë„ìš°ë¯¸ ë¼ì´ë¸Œ</h2>
                <div class="flex items-center gap-1.5 mt-0.5">
                    <span class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
                    <span class="text-[10px] font-bold opacity-80 uppercase tracking-widest">AI Analyst</span>
                </div>
            </div>
        </div>
    </div>

    <div id="chat-window" class="flex-1 overflow-y-auto p-5 space-y-6 bg-[#BACEE0]/30 scroll-smooth">
        {% for chat in history %}
        <div class="flex justify-end">
            <div class="bg-blue-600 text-white p-4 rounded-3xl rounded-tr-none shadow-md text-sm font-bold max-w-[85%] animate-fade-in">
                {{ chat.message }}
            </div>
        </div>
        <div class="flex items-start gap-3">
            <div class="w-9 h-9 rounded-xl bg-blue-600 flex items-center justify-center text-white text-[10px] font-black shadow-lg shrink-0">AI</div>
            <div class="bg-white p-4 rounded-3xl rounded-tl-none shadow-sm border border-blue-50 text-sm font-medium text-slate-700 max-w-[85%] leading-relaxed animate-fade-in">
                {{ chat.response|linebreaksbr }}
            </div>
        </div>
        {% empty %}
        <div class="flex items-start gap-3">
            <div class="w-9 h-9 rounded-xl bg-blue-600 flex items-center justify-center text-white text-[10px] font-bold shadow-lg shrink-0">AI</div>
            <div class="bg-white p-4 rounded-2xl rounded-tl-none shadow-sm border border-blue-50 text-sm font-medium max-w-[85%] text-slate-700 leading-relaxed">
                ì•ˆë…•í•˜ì„¸ìš”! <strong>{{ user.username }}</strong>ë‹˜ ğŸ«§<br>
                ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”? ë¬¼ê³ ê¸° ì´ë¦„ì„ ë§ì”€í•˜ì‹œê±°ë‚˜ ì‚¬ì§„(ğŸ“·)ì„ ë³´ë‚´ì£¼ì„¸ìš”!
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="p-5 bg-white border-t border-white shadow-[0_-10px_20px_rgba(0,0,0,0.02)]">
        <form id="chat-form" enctype="multipart/form-data" class="flex flex-col gap-3">
            {% csrf_token %}
            
            <div id="image-preview" class="hidden p-3 bg-blue-50 rounded-2xl border-2 border-dashed border-blue-200 flex items-center justify-between animate-fade-in">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center text-white text-[10px] font-bold">IMG</div>
                    <span id="file-name" class="text-xs font-bold text-blue-700 truncate max-w-[150px]"></span>
                </div>
                <button type="button" onclick="resetImage()" class="text-red-500 font-black hover:scale-125 transition-transform">Ã—</button>
            </div>

            <div class="flex items-center gap-3">
                <label class="flex-shrink-0 w-12 h-12 bg-slate-50 border border-slate-100 rounded-2xl flex items-center justify-center cursor-pointer hover:bg-blue-50 transition-all shadow-sm">
                    <input type="file" id="image-input" name="image" accept="image/*" class="hidden">
                    <span class="text-2xl">ğŸ“·</span>
                </label>

                <div class="flex-1">
                    <input type="text" id="user-input" name="message" placeholder="ë©”ì‹œì§€ ì…ë ¥..." 
                        class="w-full bg-slate-50 border-none focus:ring-2 focus:ring-blue-300 rounded-2xl px-5 py-3.5 outline-none text-sm font-medium transition-all shadow-inner">
                </div>

                <button type="submit" class="flex-shrink-0 w-14 h-14 bg-gradient-to-tr from-blue-600 to-cyan-500 text-white rounded-2xl shadow-lg shadow-blue-200 flex items-center justify-center hover:scale-105 active:scale-95 transition-all group">
                    <span class="text-3xl group-hover:rotate-12 transition-transform">ğŸ </span>
                </button>
            </div>
        </form>
    </div>
</div>

<style>
    @keyframes fade-in { 
        from { opacity: 0; transform: translateY(15px); } 
        to { opacity: 1; transform: translateY(0); } 
    }
    .animate-fade-in { animation: fade-in 0.4s ease-out forwards; }
    #chat-window::-webkit-scrollbar { width: 4px; }
    #chat-window::-webkit-scrollbar-thumb { background: rgba(0, 119, 255, 0.1); border-radius: 10px; }
    
    .setting-card {
        margin-top: 12px;
        padding: 12px;
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid #e2e8f0;
        border-radius: 16px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
</style>

<script>
    const chatForm = document.getElementById('chat-form');
    const chatWindow = document.getElementById('chat-window');
    const userInput = document.getElementById('user-input');
    const imageInput = document.getElementById('image-input');
    const imagePreview = document.getElementById('image-preview');
    const fileNameDisp = document.getElementById('file-name');

    function scrollToBottom() {
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }
    window.onload = scrollToBottom;

    imageInput.addEventListener('change', function() {
        if (this.files && this.files[0]) {
            fileNameDisp.innerText = this.files[0].name;
            imagePreview.classList.remove('hidden');
        }
    });

    function resetImage() { 
        imageInput.value = ""; 
        imagePreview.classList.add('hidden'); 
    }

    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const message = userInput.value.trim();
        if (!message && !imageInput.files[0]) return;

        appendMessage('user', message || "ì‚¬ì§„ ë¶„ì„ ìš”ì²­ ğŸ“¸");
        userInput.value = '';
        resetImage();

        const loadingId = 'loading-' + Date.now();
        appendMessage('ai', 'ì–´í•­ ë„ìš°ë¯¸ê°€ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤... ğŸ«§', loadingId);

        // [ì¤‘ìš” ìˆ˜ì •] URLì„ ì ˆëŒ€ ê²½ë¡œë¡œ ì§€ì •í•˜ì—¬ 400 ì—ëŸ¬ë¥¼ ë°©ì§€í•©ë‹ˆë‹¤.
        fetch("/chatbot/ask/", {
            method: 'POST',
            headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value },
            body: formData
        })
        .then(res => {
            if (!res.ok) throw new Error('Network response was not ok');
            return res.json();
        })
        .then(data => {
            const lb = document.getElementById(loadingId);
            if (lb) lb.closest('.flex').remove();
            
            const botMsg = data.message || data.reply;
            
            if (data.status === 'success') {
                appendMessage('ai', botMsg);
                checkAndRenderSettings(botMsg);
            } else {
                appendMessage('ai', "ì—ëŸ¬: " + (botMsg || "ì—°ê²° ì‹¤íŒ¨"));
            }
        })
        .catch(err => {
            const lb = document.getElementById(loadingId);
            if (lb) lb.closest('.flex').remove();
            appendMessage('ai', "ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (ê²½ë¡œ í™•ì¸ í•„ìš”)");
            console.error(err);
        });
    });

    function checkAndRenderSettings(text) {
        const regex = /\[SETTING:\s*temp=([\d.]+),\s*ph=([\d.]+),\s*cycle=(\d+)\]/;
        const match = text.match(regex);
        
        if (match) {
            const [_, temp, ph, cycle] = match;
            const card = document.createElement('div');
            card.className = 'flex items-start gap-3 mt-2 animate-fade-in';
            card.innerHTML = `
                <div class="w-9"></div>
                <div class="setting-card border-blue-100 bg-blue-50/50 flex-1">
                    <p class="text-[10px] font-black text-blue-600 mb-2 uppercase tracking-tighter">ğŸ“‹ ë°•ì‚¬ë‹˜ì˜ ì¶”ì²œ ì„¸íŒ…</p>
                    <div class="grid grid-cols-3 gap-1 text-center mb-3">
                        <div class="bg-white rounded-lg p-1 shadow-sm"><span class="block text-[10px] text-slate-400">ì˜¨ë„</span><b class="text-xs">${temp}Â°C</b></div>
                        <div class="bg-white rounded-lg p-1 shadow-sm"><span class="block text-[10px] text-slate-400">pH</span><b class="text-xs">${ph}</b></div>
                        <div class="bg-white rounded-lg p-1 shadow-sm"><span class="block text-[10px] text-slate-400">ì£¼ê¸°</span><b class="text-xs">${cycle}ì¼</b></div>
                    </div>
                    <button onclick="location.href='/monitoring/tanks/'" class="w-full py-2 bg-blue-600 text-white text-[11px] font-bold rounded-xl hover:bg-blue-700 transition-colors shadow-md shadow-blue-100">
                        ë‚´ ì–´í•­ì— ì ìš©í•˜ëŸ¬ ê°€ê¸°
                    </button>
                </div>
            `;
            chatWindow.appendChild(card);
            scrollToBottom();
        }
    }

    function appendMessage(sender, text, id = null) {
        const div = document.createElement('div');
        div.className = sender === 'user' ? 'flex justify-end' : 'flex items-start gap-3';
        
        const cleanText = text.replace(/\[SETTING:.*?\]/g, '').replace(/\n/g, '<br>');

        if (sender === 'user') {
            div.innerHTML = `<div class="bg-blue-600 text-white p-4 rounded-3xl rounded-tr-none shadow-md text-sm font-bold max-w-[85%] animate-fade-in">${cleanText}</div>`;
        } else {
            div.innerHTML = `
                <div class="w-9 h-9 rounded-xl bg-blue-600 flex items-center justify-center text-white text-[10px] font-black shadow-lg shrink-0">AI</div>
                <div id="${id || ''}" class="bg-white p-4 rounded-3xl rounded-tl-none shadow-sm border border-blue-50 text-sm font-medium text-slate-700 max-w-[85%] leading-relaxed animate-fade-in">${cleanText}</div>`;
        }
        chatWindow.appendChild(div);
        scrollToBottom();
    }
</script>
{% endblock %}